name: Test MCP Server

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: uv sync

    - name: Check Python syntax
      run: uv run python -m py_compile uk_weather_mcp.py

    - name: Run type checking (optional)
      run: |
        uv pip install mypy types-httpx
        uv run mypy uk_weather_mcp.py --ignore-missing-imports || true
      continue-on-error: true

    - name: Test MCP server initialization
      run: |
        # Test that the server can start and respond to basic MCP protocol
        # We use a timeout since MCP servers run indefinitely
        timeout 5s uv run uk_weather_mcp.py || exit_code=$?
        # Exit code 124 means timeout (expected), anything else is an error
        if [ $exit_code -ne 124 ] && [ $exit_code -ne 0 ]; then
          echo "Server failed to start properly"
          exit 1
        fi
        echo "Server starts successfully"

    - name: Test tool functionality with API
      env:
        MET_OFFICE_API_KEY: ${{ secrets.MET_OFFICE_API_KEY }}
      run: |
        # Create a simple test script to verify tools work
        cat > test_tools.py << 'EOF'
        import asyncio
        import sys
        from uk_weather_mcp import (
            uk_weather_get_hourly_forecast,
            uk_weather_get_three_hourly_forecast,
            uk_weather_get_daily_forecast,
            WeatherForecastInput,
            ResponseFormat
        )

        async def test_tools():
            """Test that all tools can be called successfully."""
            print("Testing UK Weather MCP tools...")

            # Test coordinates (London)
            test_input = WeatherForecastInput(
                latitude=51.5074,
                longitude=-0.1278,
                response_format=ResponseFormat.MARKDOWN
            )

            # Test hourly forecast
            print("\n1. Testing hourly forecast...")
            result = await uk_weather_get_hourly_forecast(test_input)
            if result.startswith("Error:"):
                print(f"   ❌ Failed: {result}")
                return False
            print("   ✅ Hourly forecast works")

            # Test 3-hourly forecast
            print("\n2. Testing 3-hourly forecast...")
            result = await uk_weather_get_three_hourly_forecast(test_input)
            if result.startswith("Error:"):
                print(f"   ❌ Failed: {result}")
                return False
            print("   ✅ 3-hourly forecast works")

            # Test daily forecast
            print("\n3. Testing daily forecast...")
            result = await uk_weather_get_daily_forecast(test_input)
            if result.startswith("Error:"):
                print(f"   ❌ Failed: {result}")
                return False
            print("   ✅ Daily forecast works")

            # Test JSON format
            print("\n4. Testing JSON format...")
            json_input = WeatherForecastInput(
                latitude=51.5074,
                longitude=-0.1278,
                response_format=ResponseFormat.JSON
            )
            result = await uk_weather_get_hourly_forecast(json_input)
            if result.startswith("Error:"):
                print(f"   ❌ Failed: {result}")
                return False
            # Verify it's valid JSON
            import json
            try:
                json.loads(result)
                print("   ✅ JSON format works")
            except json.JSONDecodeError:
                print("   ❌ Failed: Invalid JSON returned")
                return False

            print("\n✅ All tests passed!")
            return True

        if __name__ == "__main__":
            success = asyncio.run(test_tools())
            sys.exit(0 if success else 1)
        EOF

        uv run python test_tools.py

    - name: Test error handling
      env:
        MET_OFFICE_API_KEY: ${{ secrets.MET_OFFICE_API_KEY }}
      run: |
        # Test that invalid inputs are handled correctly
        cat > test_errors.py << 'EOF'
        import asyncio
        import sys
        from uk_weather_mcp import WeatherForecastInput, ResponseFormat
        from pydantic import ValidationError

        async def test_error_handling():
            """Test that invalid inputs are properly handled."""
            print("Testing error handling...")

            # Test 1: Invalid latitude (out of range)
            print("\n1. Testing invalid latitude...")
            try:
                invalid_input = WeatherForecastInput(
                    latitude=100.0,  # Invalid: > 90
                    longitude=0.0,
                    response_format=ResponseFormat.MARKDOWN
                )
                print("   ❌ Failed: Should have raised ValidationError")
                return False
            except ValidationError as e:
                print(f"   ✅ Correctly rejected invalid latitude")

            # Test 2: Invalid longitude (out of range)
            print("\n2. Testing invalid longitude...")
            try:
                invalid_input = WeatherForecastInput(
                    latitude=0.0,
                    longitude=200.0,  # Invalid: > 180
                    response_format=ResponseFormat.MARKDOWN
                )
                print("   ❌ Failed: Should have raised ValidationError")
                return False
            except ValidationError as e:
                print(f"   ✅ Correctly rejected invalid longitude")

            # Test 3: Missing API key (if not set)
            print("\n3. Testing missing API key handling...")
            import os
            original_key = os.environ.get("MET_OFFICE_API_KEY")
            os.environ["MET_OFFICE_API_KEY"] = ""

            from uk_weather_mcp import uk_weather_get_hourly_forecast
            valid_input = WeatherForecastInput(
                latitude=51.5074,
                longitude=-0.1278,
                response_format=ResponseFormat.MARKDOWN
            )
            result = await uk_weather_get_hourly_forecast(valid_input)

            # Restore key
            if original_key:
                os.environ["MET_OFFICE_API_KEY"] = original_key

            if "MET_OFFICE_API_KEY" in result and "not set" in result:
                print("   ✅ Correctly handles missing API key")
            else:
                print(f"   ❌ Failed: Unexpected error message: {result}")
                return False

            print("\n✅ All error handling tests passed!")
            return True

        if __name__ == "__main__":
            success = asyncio.run(test_error_handling())
            sys.exit(0 if success else 1)
        EOF

        uv run python test_errors.py

    - name: Test with multiple locations
      env:
        MET_OFFICE_API_KEY: ${{ secrets.MET_OFFICE_API_KEY }}
      run: |
        # Test with various global locations
        cat > test_locations.py << 'EOF'
        import asyncio
        import sys
        from uk_weather_mcp import (
            uk_weather_get_hourly_forecast,
            WeatherForecastInput,
            ResponseFormat
        )

        async def test_locations():
            """Test forecasts for various global locations."""
            print("Testing various global locations...")

            locations = [
                ("London, UK", 51.5074, -0.1278),
                ("New York, USA", 40.7128, -74.0060),
                ("Tokyo, Japan", 35.6762, 139.6503),
                ("Sydney, Australia", -33.8688, 151.2093),
                ("Reykjavik, Iceland", 64.1466, -21.9426),
            ]

            for name, lat, lon in locations:
                print(f"\nTesting {name} ({lat}, {lon})...")
                test_input = WeatherForecastInput(
                    latitude=lat,
                    longitude=lon,
                    response_format=ResponseFormat.MARKDOWN
                )

                result = await uk_weather_get_hourly_forecast(test_input)
                if result.startswith("Error:"):
                    print(f"   ❌ Failed: {result}")
                    return False
                print(f"   ✅ Successfully retrieved forecast")

            print("\n✅ All location tests passed!")
            return True

        if __name__ == "__main__":
            success = asyncio.run(test_locations())
            sys.exit(0 if success else 1)
        EOF

        uv run python test_locations.py

    - name: Generate test report
      if: always()
      run: |
        echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ MCP server tests completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Tests Run" >> $GITHUB_STEP_SUMMARY
        echo "- Python syntax validation" >> $GITHUB_STEP_SUMMARY
        echo "- Server initialization" >> $GITHUB_STEP_SUMMARY
        echo "- Tool functionality (all 3 forecast types)" >> $GITHUB_STEP_SUMMARY
        echo "- Error handling (invalid inputs)" >> $GITHUB_STEP_SUMMARY
        echo "- Multiple global locations" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Environment" >> $GITHUB_STEP_SUMMARY
        echo "- Python: 3.12" >> $GITHUB_STEP_SUMMARY
        echo "- Runner: ubuntu-latest" >> $GITHUB_STEP_SUMMARY
        echo "- Package Manager: uv" >> $GITHUB_STEP_SUMMARY
